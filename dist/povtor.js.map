{"version":3,"file":"povtor.js","sources":["../src/index.ts"],"sourcesContent":["export type RetryAction = (...args: any[]) => Promise<any> | any;\n\nexport type RetryTest = (value: any) => boolean;\n\nexport interface RetrySettings {\n    action: RetryAction;\n    actionContext?: any;\n    actionParams?: any[];\n    delay?: number;\n    retryAttempts?: number[];\n    retryQty?: number;\n    retryTimeout?: number;\n    retryOnError?: boolean | RetryTest;\n    retryTest?: boolean | RetryTest;\n}\n\nexport interface WithPromiseField {\n    promise: Promise<any>;\n}\n\nexport interface RetryResult extends WithPromiseField {\n    attempt: number;\n    error: any;\n    stop: () => Promise<any>;\n    stopped: boolean;\n    value: any;\n    valueWait: boolean;\n    wait: boolean;\n}\n\nexport function retry(settings: RetrySettings): RetryResult {\n    let actionResult, resultReject, resultResolve, timeoutId;\n    const resultPromise = new Promise(function(resolve, reject) {\n        resultResolve = resolve;\n        resultReject = reject;\n    });\n\n    const { retryTimeout } = settings;\n    let index = 0;\n    let stopped = false;\n\n    let attempts: number;\n    let { retryAttempts } = settings;\n    if (retryAttempts && retryAttempts.length) {\n        attempts = retryAttempts.length + 1;\n    }\n    else {\n        retryAttempts = null;\n        const { retryQty } = settings;\n        if (typeof retryQty === 'number' && retryQty >= 0) {\n            attempts = retryQty + 1;\n        }\n        else {\n            attempts = -1;\n        }\n    }\n\n    function retryAction() {\n        retryResult.attempt = ++index;\n        retryResult.wait = false;\n        retryResult.valueWait = true;\n        try {\n            actionResult = settings.action.apply(settings.actionContext || null, settings.actionParams || []);\n            if (actionResult && typeof actionResult === 'object' && typeof actionResult.then === 'function') {\n                actionResult.then(onActionEnd, onActionError);\n            }\n            else {\n                onActionEnd(actionResult);\n            }\n        }\n        catch (e) {\n            onActionError(e);\n        }\n    }\n\n    function repeat() {\n        let timeout;\n        if (index) {\n            timeout = retryAttempts\n                ? retryAttempts.shift()\n                : retryTimeout;\n        }\n        else {\n            timeout = settings.delay;\n        }\n        if (attempts > 0) {\n            attempts--;\n        }\n        if (typeof timeout !== 'number' || timeout < 0) {\n            retryAction();\n        }\n        else {\n            retryResult.wait = true;\n            timeoutId = setTimeout(retryAction, timeout);\n        }\n    }\n\n    function onActionEnd(value: any) {\n        retryResult.value = value;\n        retryResult.valueWait = false;\n        let retryTest: any;\n        if (! stopped) {\n            retryTest = settings.retryTest;\n            if (! attempts) {\n                retryTest = false;\n            }\n            else if (typeof retryTest === 'function') {\n                retryTest = retryTest(value);\n            }\n        }\n        if (retryTest) {\n            repeat();\n        }\n        else {\n            resultResolve(value);\n        }\n    }\n\n    function onActionError(reason: any) {\n        retryResult.error = reason;\n        retryResult.valueWait = false;\n        let { retryOnError } = settings;\n        if (stopped || ! attempts) {\n            retryOnError = false;\n        }\n        else if (typeof retryOnError === 'function') {\n            retryOnError = retryOnError(reason);\n        }\n        if (retryOnError) {\n            repeat();\n        }\n        else {\n            resultReject(reason);\n        }\n    }\n\n    function stopRetry() {\n        if (! stopped) {\n            if (timeoutId) {\n                clearTimeout(timeoutId);\n                retryResult.wait = false;\n            }\n            stopped = retryResult.stopped = true;\n            if (! retryResult.valueWait) {\n                resultResolve(retryResult.value);\n            }\n        }\n\n        return resultPromise;\n    }\n\n    const retryResult: RetryResult = {\n        attempt: index,\n        error: actionResult,\n        promise: resultPromise,\n        stop: stopRetry,\n        stopped: false,\n        value: actionResult,\n        valueWait: false,\n        wait: false\n    };\n\n    repeat();\n\n    return retryResult;\n}\n\nexport function getPromiseField(obj: WithPromiseField): Promise<any> {\n    return obj.promise;\n}\n"],"names":[],"mappings":";;eA8BsB;IAClB,IAAI,cAAc,cAAc,eAAe;IAC/C,IAAM,gBAAgB,IAAI,OAAJ,CAAY,UAAS,OAAS,EAAA;QAChD,aAAA,GAAgB;QAChB,YAAA,GAAe;;IAGX,IAAA;IACR,IAAI,QAAQ;IACZ,IAAI,UAAU;IAEd,IAAI;IACE,IAAA;IACN,IAAI,aAAA,IAAiB,aAAA,CAAc,QAAQ;QACvC,QAAA,GAAW,aAAA,CAAc,MAAd,GAAuB;WAEjC;QACD,aAAA,GAAgB;QACR,IAAA;QACR,IAAI,OAAO,QAAP,KAAoB,QAApB,IAAgC,QAAA,IAAY,GAAG;YAC/C,QAAA,GAAW,QAAA,GAAW;eAErB;YACD,QAAA,GAAW,CAAC;;;IAIpB;QACI,WAAA,CAAY,OAAZ,GAAsB,EAAE;QACxB,WAAA,CAAY,IAAZ,GAAmB;QACnB,WAAA,CAAY,SAAZ,GAAwB;QACxB,IAAI;YACA,YAAA,GAAe,QAAA,CAAS,MAAT,CAAgB,KAAhB,CAAsB,QAAA,CAAS,aAAT,IAA0B,MAAM,QAAA,CAAS,YAAT,IAAyB;YAC9F,IAAI,YAAA,IAAgB,OAAO,YAAP,KAAwB,QAAxC,IAAoD,OAAO,YAAA,CAAa,IAApB,KAA6B,YAAY;gBAC7F,YAAA,CAAa,IAAb,CAAkB,aAAa;mBAE9B;gBACD,WAAA,CAAY;;SAGpB,QAAO,GAAG;YACN,aAAA,CAAc;;;;IAItB;QACI,IAAI;QACJ,IAAI,OAAO;YACP,OAAA,GAAU,aAAA,GACJ,aAAA,CAAc,KAAd,KACA;eAEL;YACD,OAAA,GAAU,QAAA,CAAS;;QAEvB,IAAI,QAAA,GAAW,GAAG;YACd,QAAA;;QAEJ,IAAI,OAAO,OAAP,KAAmB,QAAnB,IAA+B,OAAA,GAAU,GAAG;YAC5C,WAAA;eAEC;YACD,WAAA,CAAY,IAAZ,GAAmB;YACnB,SAAA,GAAY,UAAA,CAAW,aAAa;;;;IAI5C,qBAAqB;QACjB,WAAA,CAAY,KAAZ,GAAoB;QACpB,WAAA,CAAY,SAAZ,GAAwB;QACxB,IAAI;QACJ,IAAI,CAAE,SAAS;YACX,SAAA,GAAY,QAAA,CAAS;YACrB,IAAI,CAAE,UAAU;gBACZ,SAAA,GAAY;mBAEX,IAAI,OAAO,SAAP,KAAqB,YAAY;gBACtC,SAAA,GAAY,SAAA,CAAU;;;QAG9B,IAAI,WAAW;YACX,MAAA;eAEC;YACD,aAAA,CAAc;;;;IAItB,uBAAuB;QACnB,WAAA,CAAY,KAAZ,GAAoB;QACpB,WAAA,CAAY,SAAZ,GAAwB;QAClB,IAAA;QACN,IAAI,OAAA,IAAW,CAAE,UAAU;YACvB,YAAA,GAAe;eAEd,IAAI,OAAO,YAAP,KAAwB,YAAY;YACzC,YAAA,GAAe,YAAA,CAAa;;QAEhC,IAAI,cAAc;YACd,MAAA;eAEC;YACD,YAAA,CAAa;;;;IAIrB;QACI,IAAI,CAAE,SAAS;YACX,IAAI,WAAW;gBACX,YAAA,CAAa;gBACb,WAAA,CAAY,IAAZ,GAAmB;;YAEvB,OAAA,IAAU,WAAA,CAAY,OAAZ,GAAsB;YAChC,IAAI,CAAE,WAAA,CAAY,WAAW;gBACzB,aAAA,CAAc,WAAA,CAAY;;;QAIlC,OAAO;;;IAGX,IAAM,cAA2B;QAC7B,SAAS,KADoB;QAE7B,OAAO,YAFsB;QAG7B,SAAS,aAHoB;QAI7B,MAAM,SAJuB;QAK7B,SAAS,KALoB;QAM7B,OAAO,YANsB;QAO7B,WAAW,KAPkB;QAQ7B,MAAM;;IAGV,MAAA;IAEA,OAAO;;;AAGX,yBAAgC;IAC5B,OAAO,GAAA,CAAI;;;;;;"}